# Freedom QR Provider SDK

[![](https://jitpack.io/v/freedompay-global/freedom-qr-provider-android-sdk.svg)](https://jitpack.io/#freedompay-global/freedom-qr-provider-android-sdk)

Freedom QR Provider - SDK для получения платежного QR кода, а так же взаимодействия с API Freedom Pay.

- [Предварительные этапы](#предварительные-этапы)
- [Требования](#требования)
- [Подключение](#подключение)
- [Интеграция](#интеграция)
  - [Начало](#начало)
  - [Инициализация запросов](#инициализация-запросов)
  - [Информация об ошибке](#информация-об-ошибке)
- [Пример работы с SDK](#пример-работы-с-sdk)
  - [Получение платежного QR кода](#получение-платежного-qr-кода)
  - [Получение статуса платежа](#получение-статуса-платежа)
  - [Отмена платежа](#отмена-платежа)
  - [Возврат платежа](#возврат-платежа)
- [Поддержка](#поддержка)

## Предварительные этапы

Для начала работы с QR provider SDK в качестве партнера заполните заявку на
подключение мерчанта.
После создания и подключения мерчанта в личном кабинете вы получите
`Merchant_ID` и `Secret_key` которые необходимы для взаимодействия с SDK.

## Требования
Для работы QR provider SDK необходим Android версии 5.0 (API level 24).


## Подключение
Для подключения SDK добавьте в `build.gradle` вашего корневогого проекта следующую строчку:

```groovy
allprojects {
    repositories {
        maven { url 'https://jitpack.io' }
    }
}
```

Так же добавьте в `build.gradle` вашего проекта следующую строчку:

```groovy
dependencies {
    implementation "com.github.freedompay-global:freedom-qr-provider-android-sdk:${version}"
}
```
`version` - текущая версия SDK.


## Интеграция


### Начало

Всё необходимое взаимодействие в библиотеке происходит только через класс `FreedomQrProvider`.

Для инициализации SDK в вашем фрагменте или активити необходимо создать объект:
```kotlin 
private val sdk = FreedomQrProvider.initialize(secretKey, merchantId)
```

`secretKey: String` - секретный ключ, который выдается при подключения мерчанта в личном кабинете.

`merchanId: String` - уникальный идентификатор, который присваивается мерчанту после создания аккаунта.

### Инициализация запросов

После создания объекта SDK, необходимо ознакомиться с основной структурой параметров для инициализации запросов, состоящая из
`params` и `callbacks`.

```kotlin
sdkObject.methodName("params",
    onResult = { result ->
        // результат выполнения запроса
    },
    onError = { serverError ->
        // ошибка с сервера
    },
    onFailure = { exception ->
        // ошибка отправки запроса
    }
)
```
- `sdkObject` - объект SDK, который был проинициализирован


- `methodName` - название метода, который был вызван пользователем


### Параметры запросов

| Параметр    | Описание                                                                                         |
|-------------|--------------------------------------------------------------------------------------------------|
| `params`    | Один или несколько параметров, которые необходимо передать пользователю для совершения запроса   |
| `onResult`  | Возвращает объект выполнения запроса `<T>`                                                       |
| `onError`   | Возвращает объект `ErrorResponse`, который позволяет получить информацию об ошибке               |
| `onFailure` | Возвращает объект  `Exception`, который позволяет получить информацию об ошибке отправки запроса |


### Информация об ошибке
Объект который позволяет получить информацию об ошибке с сервера:

| Поле        | Описание                                                                                            |
|-------------|-----------------------------------------------------------------------------------------------------|
| `code`      | Код, возвращаемой ошибки с сервера. С основными кодами ошибок можно ознакомиться в [документации]() |
| `message`   | Сообщение об ошибке                                                                                 |


## Пример работы с SDK

### Получение платежного QR кода

Для получения платежного QR кода необходимо вызвать метод `sdk.getQR`.

В метод также необходимо передать следующие параметры:
- `orderId: String` - идентификатор платежа в системе мерчанта. Рекомендуется поддерживать уникальность этого поля.
- `amount: Double` - сумма платежа в валюте `currency`
- `description: String` - описание товара или услуги. Отображается покупателю в процессе платежа.
- `currency: String` - валюта, в которой указана сумма. Пример: KZT, USD, EUR

Пример вызова метода для получения платежного QR кода:

```kotlin
sdk.getQR("orderId", amount, "description", "currency", 
    onResult = {
    // результат выполнения запроса         
    },
    onStatusChanged = {
    // отслеживание статуса оплаты QR кода
    },
    onError = { serverError ->
    // ошибка с сервера
    },
    onFailure = { exception ->
    // ошибка отправки запроса
    }
)
```

В результате успешного вызова метода получения платежного QR кода в callback `onResult` вернется объект `InitPaymentResponse`,
содержащий следующие поля:

| Поле               | Описание                                                                         |
|--------------------|----------------------------------------------------------------------------------|
| `status`           | Статус выполнения запроса                                                        |
| `invoiceStatus`    | Статус счёта                                                                     |
| `errorCode`        | ID кода ошибки                                                                   |
| `errorDescription` | Текстовое описание ошибки                                                        |
| `invoiceId`        | Идентификатор транзакции в система FreedomPay                                    |
| `invoiceMethods`   | Объект содержит запрошенные мерчантом способы выставления счета `InvoiceMethods` |
| `dt`               | Дата и время запроса в формате `YYYY-MM-DDThh:mm:ss±hh:mm`                       |

Примечание:
- Статус счёта `invoiceStatus` может иметь разные состояния:

| Значение     | Описание                                   |
|--------------|--------------------------------------------|
| `new`        | Создан новый счёт                          |
| `process`    | Ожидание плательщика или платежной системы |
| `ok`         | Счёт успешно оплачен                       |
| `failed`     | Ошибка оплаты счёта                        |
| `incomplete` | Истекло время жизни счёта                  |

- Способ выставления счёта `invoiceMethods` представляет собой объект `InvoiceMethods`, который содержит единственное поле:

| Поле | Описание                                                       |
|------|----------------------------------------------------------------|
| `qr` | Картинка для отображения платежного QR кода в формате `Bitmap` |

> Так же стоить отметить callback `onStatusChanged`, который позволяет отследить статус оплаты QR кода
и в зависимости от результата выполнения оплаты вернуть статус из поля `invoiceStatus`

> Для прекращения отслеживания статуса оплаты QR кода, необходимо в вашем фрагменте или активити
переопределить `onPause` или `onDestroy` и вызвать метод `sdk.stopStatusUpdates()`. 
<br> Вызов метода обязателен только в том случае, когда прослушивается callback `onStatusChanged`.

Пример вызова метода для прекращения прослушивания статуса оплаты QR кода:

```kotlin
override fun onDestroy() {
    super.onDestroy()
    sdk.stopStatusUpdates()
}
```

### Получение статуса платежа

Для получения статуса платежа доступны следующие методы:

- Получение статуса платежа по `orderId: String` - идентификатор платежа в системе мерчанта
- Получение статуса платежа по `invoiceId: Int` - идентификатор платежа в системе FreedomPay

Для получения статуса платежа необходимо вызвать метод `sdk.getPaymentStatus` и передать в параметры
одно из полей `orderId` или `invoiceId`.

Пример вызова метода получения статуса оплаты по `orderId`:
```kotlin
sdk.getPaymentStatus(orderId,
    onResult = { result ->
        // результат выполнения запроса
    },
    onError = { serverError ->
        // ошибка с сервера
    },
    onFailure = { exception ->
        // ошибка отправки запроса
    }
)
```

Пример вызова метода получения статуса оплаты по `invoiceId`:
```kotlin
sdk.getPaymentStatus(invoiceId,
    onResult = { result ->
        // результат выполнения запроса
    },
    onError = { serverError ->
        // ошибка с сервера
    },
    onFailure = { exception ->
        // ошибка отправки запроса
    }
)
```

В результате успешного вызова одного из методов получения статуса платежа в callback `onResult` вернется объект `PaymentStatusResponse`,
содержащий следующие поля:

| Поле               | Описание                                                   |
|--------------------|------------------------------------------------------------|
| `status`           | Результат выполнения запроса                               |
| `invoiceStatus`    | Статус счёта                                               |
| `invoiceId`        | Уникальный идентификатор счёта в систему Freedom Pay       |
| `errorCode`        | ID кода ошибки                                             |
| `errorDescription` | Текстовое описание ошибки                                  |
| `cardPan`          | Маскированный пан карты                                    |
| `cardToken`        | Уникальный идентификатор карты                             |
| `amount`           | Сумма оплаты в валюте поля `currency`                      |
| `currency`         | Валюта платежа                                             |
| `dt`               | Дата и время запроса в формате `YYYY-MM-DDThh:mm:ss±hh:mm` |

### Отмена платежа

Для отмены платежа необходимо вызвать метод `sdk.cancelPayment`.

В метод так же необходимо передать единственный параметр:
- `invoiceId: Int` - yникальный идентификатор платежной транзакции в FreedomPay. Пример: `12345`

Пример вызова метода для отмены платежа:
```kotlin
sdk.cancelPayment(invoiceId,
    onResult = { result ->
        // результат выполнения запроса
    },
    onError = { serverError ->
        // ошибка с сервера
    },
    onFailure = { exception ->
        // ошибка отправки запроса
    }
)
```
В результате успешного вызова метода отмены платежа в callback `onResult` вернется объект `OperationResultResponse`,
содержащий следующие поля:

| Поле     | Описание                   |
|----------|----------------------------|
| `status` | Статус выполнения операции |

Примечание: `status` статус выполнения операции может иметь следующие состояния:

| Значение | Описание |
|----------|----------|
| `ok`     | Успешно  |
| `error`  | Ошибка   |

### Возврат платежа

Для возврата платежа необходимо вызвать метод `sdk.refundPayment`.

В метод так же необходимо передать единственный параметр:
- `invoiceId: Int` - yникальный идентификатор платежной транзакции в FreedomPay. Пример: `12345`
- `refundAmount: Double` - сумма возврата платежа. Пример: `50.0`

Пример вызова метода для отмены платежа:
```kotlin
sdk.refundPayment(invoiceId, refundAmount,
    onResult = { result ->
        // результат выполнения запроса
    },
    onError = { serverError ->
        // ошибка с сервера
    },
    onFailure = { exception ->
        // ошибка отправки запроса
    }
)
```

В результате успешного вызова метода возврата платежа в callback `onResult` вернется тот же самый объект,
что и при операции [отмены платежа](#отмена-платежа) `OperationResultResponse`

## Поддержка

- По возникающим вопросам просьба обращаться на [support@freedompay.money](mailto:support@freedompay.money)